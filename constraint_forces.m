%% constraint_forces.m
%
% Description:
%   Output function to compute the constraint forces acting on the jumping
%   robot
%
% Inputs:
%   tseg: the array of time values selected by ode45
%   xseg: the 10xlength(tseg) array of states computed by ode45;
%   params: a struct with many elements, generated by calling init_params.m
%
% Outputs:
%   Fseg: a 4xlength(tsim) array of constraint forces

function [Fseg] = constraint_forces(tseg,xseg,params)

Fseg = zeros(4,length(tseg));

for i=1:length(tseg)
    t = tseg(i);
    x = xseg(:,i);
    q_dot = x(6:10);
    
    % for convenience, define q and q_dot
    nq = numel(x)/2;    % assume that x = [q;q_dot];
    q = x(1:nq);
    q_dot = x(nq+1:2*nq);

    % solve for control inputs at this instant
    tau_s = interp1(params.motor.spine.time,params.motor.spine.torque,t);
    tau_m = interp1(params.motor.body.time,params.motor.body.torque,t);
    Q = [0;0;0;tau_s;tau_m];

    % find the parts that don't depend on constraint forces
    H = H_eom(x,params);
    M = mass_matrix(x,params);
    Minv = inv_mass_matrix(x,params);
    [A_all,Hessian] = constraint_derivatives(x,params);

    % build the constraints and forces 
    switch params.sim.constraints  
        case ['false','false']      % both feet are off the ground
            Fseg(:,i) = zeros(4,1);
        case ['true','false']      % left foot is on the ground and right is off
            A = A_all([1,2],:);
            Adotqdot = [q_dot'*Hessian(:,:,1)*q_dot;
                        q_dot'*Hessian(:,:,2)*q_dot ];
            F = inv(A*Minv*A')*(A*Minv*(Q - H) + Adotqdot);
            Fseg(:,i) = [F(1); F(2); 0; 0];
        case ['false','true']      % right foot is on the ground and left is off
            A = A_all([3,4],:);
            Adotqdot = [q_dot'*Hessian(:,:,3)*q_dot;
                        q_dot'*Hessian(:,:,4)*q_dot ];
            F = inv(A*Minv*A')*(A*Minv*(Q - H) + Adotqdot);
            Fseg(:,i) = [0; 0; F(1); F(2)];
        case ['true','true']      % both feet are on the ground
            A = A_all([1,2,4],:);
            Adotqdot = [q_dot'*Hessian(:,:,1)*q_dot;
                        q_dot'*Hessian(:,:,2)*q_dot;
                        q_dot'*Hessian(:,:,4)*q_dot ];
            F = inv(A*Minv*A')*(A*Minv*(Q - H) + Adotqdot);
            Fseg(:,i) = [F(1)*F(2)/(F(2)+F(3)); F(2); F(1)*F(3)/(F(2)+F(3)); F(3)];
    end
end

end


